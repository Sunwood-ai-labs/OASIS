name: READMEã®ç¿»è¨³

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  GITHUB_TOKEN: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  GITHUB_REPOSITORY: ${{ github.repository }}
  YOUR_PERSONAL_ACCESS_TOKEN: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN }}
  YOUR_PERSONAL_ACCESS_TOKEN_IRIS: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}

jobs:
  translate-readme:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆ
        run: |
          git checkout -b translate-readme-${{ github.run_id }}

      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/requirements.txt

      - name: READMEã®ç¿»è¨³
        run: |
          python .github/scripts/translate_readme.py

      - name: å¤‰æ›´ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
        id: check_changes
        run: |
          git config --global user.name "iris-s-coon"
          git config --global user.email "iris.sol.coon@gmail.com"
          git add docs/README.en.md
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ğŸ“– [docs] è‹±èªREADMEã®æ›´æ–°"
            echo "å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git push origin translate-readme-${{ github.run_id }}

      - name: ãƒ©ãƒ™ãƒ«ã®ç¢ºèªã¨ä½œæˆ
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ env.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
        run: |
          if ! gh label list | grep -q "automated pr"; then
            gh label create "automated pr" --color "#0E8A16" --description "è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"
          fi

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ env.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
        run: |
          gh pr create --title "ğŸ“– [docs] è‹±èªREADMEã®è‡ªå‹•æ›´æ–°" \
                       --body "ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€README.mdã®å¤‰æ›´ã«åŸºã¥ã„ã¦ã€README.en.mdã‚’è‡ªå‹•æ›´æ–°ã—ãŸã‚‚ã®ã§ã™ã€‚å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚" \
                       --base main \
                       --head translate-readme-${{ github.run_id }} \
                       --label "documentation" \
                       --label "automated pr"

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•ãƒãƒ¼ã‚¸
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ env.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
        run: |
          PR_NUMBER=$(gh pr list --head translate-readme-${{ github.run_id }} --json number --jq '.[0].number')
          gh pr merge $PR_NUMBER --auto --merge

      - name: ãƒ–ãƒ©ãƒ³ãƒã®å‰Šé™¤
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ env.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
        run: |
          PR_NUMBER=$(gh pr list --head translate-readme-${{ github.run_id }} --json number --jq '.[0].number')
          if [ ! -z "$PR_NUMBER" ]; then
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #$PR_NUMBER ã¯è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚"
          else
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯æ—¢ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚"
            git push origin --delete translate-readme-${{ github.run_id }}
          fi

      - name: å¤‰æ›´ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "READMEã«å¤‰æ›´ãŒãªã„ãŸã‚ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
